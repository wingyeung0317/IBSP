# é€šçŸ¥ç³»çµ±æ›´æ–° - æ˜è¿·è­¦å ±åŠŸèƒ½

## æ›´æ–°æ—¥æœŸ
2025-12-07

## æ›´æ–°å…§å®¹

### 1. æ–°å¢æ˜è¿·ï¼ˆUnconsciousï¼‰è­¦å ± ğŸ†˜

ç³»çµ±ç¾åœ¨æœƒåµæ¸¬å“¡å·¥è·Œå€’å¾Œç„¡ç§»å‹•ï¼ˆfall_state == 3 DANGEROUSï¼‰ï¼Œä¸¦ç™¼é€æœ€é«˜å„ªå…ˆç´šçš„æ˜è¿·è­¦å ±ã€‚

#### è§¸ç™¼æ¢ä»¶
- ESP32 åµæ¸¬åˆ°è·Œå€’äº‹ä»¶
- è·Œå€’å¾Œ 3 ç§’å…§æ²’æœ‰ç§»å‹•ï¼ˆåŠ é€Ÿåº¦è®ŠåŒ–é‡æ¥µå°ï¼‰
- `fall_state` = 3 (DANGEROUS)

#### è­¦å ±å„ªå…ˆç´š
```
æ˜è¿·è­¦å ± (fall_state=3) > è·Œå€’è­¦å ± (fall_state=2) > å…¶ä»–è­¦å ±
```

#### æ˜è¿·è­¦å ±è¨Šæ¯ç¯„ä¾‹

**Telegram:**
```
ğŸ†˜ *æ˜è¿·è­¦å ± - ç·Šæ€¥ï¼*

â° æ™‚é–“ï¼š2025-12-07 14:30:25
ğŸ“± è£ç½®ï¼š`ESP32-001`
âš ï¸ ç‹€æ…‹ï¼š*åµæ¸¬åˆ°è·Œå€’å¾Œç„¡ç§»å‹•*
ğŸ“ å‚¾æ–œè§’åº¦ï¼šN/AÂ°
ğŸ’“ å¿ƒç‡ï¼š85 bpm
ğŸŒ¡ï¸ é«”æº«ï¼š36.8Â°C

ğŸš¨ *å“¡å·¥å¯èƒ½å¤±å»æ„è­˜ï¼Œè«‹ç«‹å³å‰å¾€ç¾å ´ï¼*
```

**Discord:**
- æ¨™é¡Œï¼šğŸ†˜ æ˜è¿·è­¦å ± - ç·Šæ€¥
- æ·±ç´…è‰²é‚Šæ¡† (0x8B0000)
- ç‹€æ…‹æ¬„ä½é¡¯ç¤ºã€Œè·Œå€’å¾Œç„¡ç§»å‹•ã€

### 2. ä¿®æ­£è·Œå€’è­¦å ±æ ¼å¼ âœ…

ä¿®æ­£äº†ç•¶æ„Ÿæ¸¬å™¨æ•¸æ“šä¸å­˜åœ¨æ™‚çš„é¡¯ç¤ºå•é¡Œï¼Œç¢ºä¿æ­£ç¢ºé¡¯ç¤º "N/A"ã€‚

#### ä¿®æ­£å‰
```javascript
fallData.jerk_magnitude?.toFixed(2) || 'N/A'  // âŒ ç•¶å€¼ç‚º 0 æ™‚æœƒéŒ¯èª¤é¡¯ç¤º N/A
```

#### ä¿®æ­£å¾Œ
```javascript
fallData.jerk_magnitude != null ? fallData.jerk_magnitude.toFixed(2) : 'N/A'  // âœ… æ­£ç¢ºåˆ¤æ–·
```

#### å½±éŸ¿çš„æ¬„ä½
- âš¡ è¡æ“ŠåŠ› (jerk_magnitude)
- ğŸ“ å‚¾æ–œè§’åº¦ (pitch_angle)
- ğŸ’“ å¿ƒç‡ (heart_rate)
- ğŸŒ¡ï¸ é«”æº« (body_temperature)

### 3. å¾ LoRa å°åŒ…è®€å– fall_state

ç³»çµ±ç¾åœ¨æœƒå¾ LoRa å¯¦æ™‚æ•¸æ“šå°åŒ…ï¼ˆPacket Type 1ï¼‰ä¸­è®€å– `fall_state` æ¬„ä½ï¼š

#### Fall State å®šç¾©
```
0 = NORMAL      - æ­£å¸¸
1 = WARNING     - è­¦å‘Šï¼ˆåµæ¸¬åˆ°ç•°å¸¸ä½†æœªç¢ºèªç‚ºè·Œå€’ï¼‰
2 = FALL        - è·Œå€’ç¢ºèª
3 = DANGEROUS   - å±éšªï¼ˆè·Œå€’å¾Œç„¡ç§»å‹•ï¼Œå¯èƒ½æ˜è¿·ï¼‰
4 = RECOVERY    - æ¢å¾©ä¸­
```

#### å°åŒ…æ ¼å¼ï¼ˆPacket Type 1 - Realtime Dataï¼‰
```
Byte 0:  Packet Type (0x01)
Byte 1:  Heart Rate (BPM)
Byte 2:  Body Temperature (encoded)
Byte 3:  Ambient Temperature (encoded)
Byte 4:  Noise Level (0-255)
Byte 5:  Fall State (0-4)  â† æ–°å¢è®€å–æ­¤æ¬„ä½
Byte 6:  Alert Flags (bits)
Byte 7-8: RSSI
Byte 9:  SNR
```

## è­¦å ±é‚è¼¯æµç¨‹

```
LoRa Gateway æ¥æ”¶å°åŒ…
    â†“
Raspberry Pi (uart_lora_receiver.py)
    â†“
è§£æ fall_state æ¬„ä½
    â†“
è½‰ç™¼åˆ° API Server
    â†“
API Server æª¢æŸ¥ fall_state
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ fall_state=3â”‚ fall_state=2â”‚ alert_flags â”‚
â”‚ (æ˜è¿·)      â”‚ (è·Œå€’)      â”‚ (å…¶ä»–è­¦å ±)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“              â†“              â†“
ç™¼é€æ˜è¿·è­¦å ±  ç™¼é€è·Œå€’è­¦å ±  ç™¼é€å…¶ä»–è­¦å ±
```

## ç¨‹å¼ç¢¼ä¿®æ”¹

### ä¿®æ”¹çš„æª”æ¡ˆ

1. **`backend/api/notificationService.js`**
   - æ–°å¢ `formatUnconsciousAlert()` å‡½æ•¸
   - ä¿®æ­£ `formatFallAlert()` çš„ N/A åˆ¤æ–·
   - åœ¨ `sendAlert()` ä¸­æ·»åŠ  `unconscious` é¡å‹è™•ç†

2. **`backend/api/server.js`**
   - åœ¨å¯¦æ™‚æ•¸æ“šè™•ç†ä¸­æ·»åŠ  fall_state æª¢æŸ¥
   - å„ªå…ˆè™•ç† fall_state == 3 (æ˜è¿·)
   - ç„¶å¾Œè™•ç† fall_state == 2 (è·Œå€’)
   - æœ€å¾Œè™•ç†å…¶ä»– alert_flags

## æ¸¬è©¦æ–¹æ³•

### 1. æ¸¬è©¦æ˜è¿·è­¦å ±

ä½¿ç”¨ ESP32 æ¨¡æ“¬è·Œå€’å¾Œç„¡ç§»å‹•ï¼š
```cpp
// ESP32 ä»£ç¢¼æœƒè‡ªå‹•åµæ¸¬è·Œå€’å¾Œ 3 ç§’ç„¡ç§»å‹•
// fall_state æœƒè‡ªå‹•è®Šç‚º 3
```

### 2. æ‰‹å‹•æ¸¬è©¦ API

```powershell
# æ¸¬è©¦æ˜è¿·è­¦å ±
$body = @{
    device_id = "ESP32-001"
    packet_type = 1
    data = [Convert]::ToBase64String([byte[]](0x01, 85, 150, 150, 100, 3, 0x04, 0, 0, 0))
    timestamp = (Get-Date).ToString("o")
    frame_counter = 100
    rssi = -65
} | ConvertTo-Json

Invoke-RestMethod -Uri "http://192.168.1.137:5000/api/sensor-data" `
    -Method POST `
    -Body $body `
    -ContentType "application/json"
```

### 3. æŸ¥çœ‹æ—¥èªŒ

```powershell
# æŸ¥çœ‹ API æ—¥èªŒ
docker logs health-monitor-api -f --tail 50

# æ‡‰è©²çœ‹åˆ°ï¼š
# ğŸš¨ UNCONSCIOUS DETECTED for ESP32-001!
# ğŸ“¢ Sending unconscious alert for device ESP32-001
```

## éƒ¨ç½²æ­¥é©Ÿ

### 1. åœæ­¢ç¾æœ‰å®¹å™¨
```powershell
cd c:\Users\user\Code\Project\IBSP\backend
docker-compose down
```

### 2. é‡æ–°å»ºç½®ä¸¦å•Ÿå‹•
```powershell
docker-compose up -d --build
```

### 3. é©—è­‰æ›´æ–°
```powershell
# æŸ¥çœ‹å•Ÿå‹•æ—¥èªŒ
docker logs health-monitor-api --tail 50

# æ‡‰è©²çœ‹åˆ°ï¼š
# âœ… Database connected
# âœ… Telegram notifications enabled
```

### 4. æ¸¬è©¦é€šçŸ¥
```powershell
.\test-notifications.ps1
```

## è­¦å ±å†·å»æ™‚é–“

| è­¦å ±é¡å‹ | å†·å»æ™‚é–“ | èªªæ˜ |
|---------|---------|------|
| æ˜è¿· (unconscious) | 5 åˆ†é˜ | é¿å…é‡è¤‡é€šçŸ¥ |
| è·Œå€’ (fall) | 5 åˆ†é˜ | é¿å…é‡è¤‡é€šçŸ¥ |
| å¿ƒç‡ç•°å¸¸ | 5 åˆ†é˜ | é¿å…é »ç¹é€šçŸ¥ |
| é«”æº«ç•°å¸¸ | 5 åˆ†é˜ | é¿å…é »ç¹é€šçŸ¥ |
| å™ªéŸ³éé«˜ | 5 åˆ†é˜ | é¿å…é »ç¹é€šçŸ¥ |

**æ³¨æ„**ï¼šé›–ç„¶æœ‰å†·å»æ™‚é–“ï¼Œä½†å¦‚æœ fall_state å¾ 2 è®Šç‚º 3ï¼ˆè·Œå€’è®Šç‚ºæ˜è¿·ï¼‰ï¼Œä»æœƒç™¼é€æ–°çš„æ˜è¿·è­¦å ±ã€‚

## å¯¦éš›æ¡ˆä¾‹

### æ¡ˆä¾‹ 1: å“¡å·¥è·Œå€’ä½†ç«‹å³èµ·èº«
```
æ™‚é–“ T0: fall_state = 2 â†’ ç™¼é€ã€Œè·Œå€’è­¦å ±ã€
æ™‚é–“ T1: å“¡å·¥èµ·èº«
æ™‚é–“ T2: fall_state = 4 (Recovery)
çµæœï¼šåªæ”¶åˆ°ä¸€æ¬¡è·Œå€’è­¦å ±
```

### æ¡ˆä¾‹ 2: å“¡å·¥è·Œå€’å¾Œå¤±å»æ„è­˜
```
æ™‚é–“ T0: fall_state = 2 â†’ ç™¼é€ã€Œè·Œå€’è­¦å ±ã€
æ™‚é–“ T3: 3ç§’å¾Œä»ç„¡ç§»å‹•
æ™‚é–“ T3: fall_state = 3 â†’ ç™¼é€ã€Œæ˜è¿·è­¦å ±ã€(ç·Šæ€¥)
çµæœï¼šæ”¶åˆ°å…©æ¬¡è­¦å ±ï¼ˆè·Œå€’ + æ˜è¿·ï¼‰
```

### æ¡ˆä¾‹ 3: å“¡å·¥ç›´æ¥æ˜è¿·ï¼ˆä¾‹å¦‚å¿ƒè‡Ÿç—…ï¼‰
```
æ™‚é–“ T0: fall_state = 2 â†’ ç™¼é€ã€Œè·Œå€’è­¦å ±ã€
æ™‚é–“ T3: fall_state = 3 â†’ ç™¼é€ã€Œæ˜è¿·è­¦å ±ã€
æ™‚é–“ T3+: æŒçºŒç„¡ç§»å‹•
çµæœï¼šå…©æ¬¡è­¦å ±ï¼Œ5åˆ†é˜å†·å»å¾Œä¸å†é‡è¤‡
```

## æ³¨æ„äº‹é …

1. **N/A é¡¯ç¤º**ï¼šç•¶ LoRa å¯¦æ™‚å°åŒ…ï¼ˆType 1ï¼‰ä¸­æ²’æœ‰è¡æ“ŠåŠ›å’Œå‚¾æ–œè§’åº¦æ•¸æ“šæ™‚ï¼Œæœƒé¡¯ç¤º "N/A"ã€‚å®Œæ•´æ•¸æ“šåªåœ¨è·Œå€’äº‹ä»¶å°åŒ…ï¼ˆType 3ï¼‰ä¸­æä¾›ã€‚

2. **å„ªå…ˆç´š**ï¼šæ˜è¿·è­¦å ±çš„å„ªå…ˆç´šé«˜æ–¼è·Œå€’è­¦å ±ï¼Œç¢ºä¿æœ€åš´é‡çš„æƒ…æ³å„ªå…ˆè™•ç†ã€‚

3. **å†·å»æ©Ÿåˆ¶**ï¼šé›–ç„¶æœ‰ 5 åˆ†é˜å†·å»ï¼Œä½†æ˜è¿·å’Œè·Œå€’æ˜¯ç¨ç«‹çš„è­¦å ±é¡å‹ï¼Œå¯ä»¥åŒæ™‚è§¸ç™¼ã€‚

4. **è³‡æ–™ä¾†æº**ï¼š
   - Packet Type 1 (Realtime): åŒ…å« fall_stateï¼Œä½†ç„¡è¡æ“ŠåŠ›å’Œè§’åº¦
   - Packet Type 3 (Fall Event): åŒ…å«å®Œæ•´è·Œå€’æ•¸æ“šï¼ˆè¡æ“ŠåŠ›ã€è§’åº¦ã€åŠ é€Ÿåº¦ç­‰ï¼‰

## æœªä¾†æ”¹é€²å»ºè­°

1. âœ… **å·²å¯¦ä½œ**ï¼šå¾ fall_state è®€å–æ˜è¿·ç‹€æ…‹
2. âœ… **å·²å¯¦ä½œ**ï¼šä¿®æ­£ N/A é¡¯ç¤ºå•é¡Œ
3. ğŸ”„ **å»ºè­°**ï¼šç•¶æ”¶åˆ° Packet Type 3ï¼ˆå®Œæ•´è·Œå€’æ•¸æ“šï¼‰æ™‚ï¼Œæ›´æ–°ä¹‹å‰çš„ Realtime è­¦å ±ï¼Œè£œå……è¡æ“ŠåŠ›å’Œè§’åº¦è³‡è¨Š
4. ğŸ”„ **å»ºè­°**ï¼šåœ¨ Dashboard ä¸Šé¡¯ç¤º fall_state ç‹€æ…‹
5. ğŸ”„ **å»ºè­°**ï¼šæ·»åŠ æ˜è¿·è­¦å ±ç¢ºèªæ©Ÿåˆ¶ï¼ˆä¸»ç®¡ç¢ºèªå·²è™•ç†ï¼‰

---

**æ›´æ–°è€…**: AI Assistant  
**ç‰ˆæœ¬**: 1.1  
**ä¸Šæ¬¡æ›´æ–°**: 2025-12-07
